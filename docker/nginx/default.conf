# =============================================================================
# CREATIVE TREES - NGINX CONFIGURATION (Enterprise-Grade)
# =============================================================================
# Security Headers: OWASP Secure Headers Project
# Performance: Optimized for Laravel + Filament
# =============================================================================

server {
    listen 80;
    server_name _;

    # Docker internal DNS resolver
    resolver 127.0.0.11 valid=30s ipv6=off;

    # Document root
    root /var/www/html/public;
    index index.php index.html;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Hide nginx version
    server_tokens off;

    # =========================================================================
    # SECURITY HEADERS (OWASP Secure Headers Project)
    # =========================================================================

    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # XSS Protection (legacy browsers)
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer Policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content Security Policy (Laravel + Filament + Livewire compatible)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.bunny.net; font-src 'self' https://fonts.gstatic.com https://fonts.bunny.net data:; img-src 'self' data: https: blob:; connect-src 'self' ws: wss:; frame-ancestors 'self'; form-action 'self'; base-uri 'self';" always;

    # Permissions Policy
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;

    # =========================================================================
    # PERFORMANCE OPTIMIZATIONS
    # =========================================================================

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    # Client body size (file uploads)
    client_max_body_size 100M;
    client_body_timeout 120s;
    client_header_timeout 120s;

    # Buffers
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    # =========================================================================
    # STATIC FILES CACHING
    # =========================================================================

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff" always;
        access_log off;
        try_files $uri =404;
    }

    # =========================================================================
    # MAIN LOCATION
    # =========================================================================

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # =========================================================================
    # PHP-FPM HANDLER
    # =========================================================================

    location ~ \.php$ {
        try_files $uri =404;

        # FastCGI settings
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        # Dynamic upstream (Docker)
        set $upstream "app:9000";
        fastcgi_pass $upstream;
        fastcgi_index index.php;

        # Timeouts
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 120s;
        fastcgi_read_timeout 120s;

        # Buffers
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
    }

    # =========================================================================
    # HEALTH CHECK ENDPOINT
    # =========================================================================

    location = /up {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "OK";
    }

    # =========================================================================
    # SECURITY: BLOCK SENSITIVE FILES
    # =========================================================================

    # Block access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Block access to sensitive files
    location ~* (\.env|\.git|\.htaccess|composer\.(json|lock)|package(-lock)?\.json|phpunit\.xml|artisan)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Block PHP files in uploads directory
    location ~* /storage/.*\.php$ {
        deny all;
    }

    # Block access to vendor directory
    location ^~ /vendor/ {
        deny all;
    }
}

