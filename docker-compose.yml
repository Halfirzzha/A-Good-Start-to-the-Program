# =============================================================================
# CREATIVE TREES - ENTERPRISE DOCKER COMPOSE (ALL-IN-ONE)
# =============================================================================
# Version: 2.0.0 | Date: 2026-02-02
#
# CARA PENGGUNAAN:
# ================
# Start semua services:     docker compose up -d
# Lihat logs:               docker compose logs -f
# Stop semua:               docker compose down
# Rebuild:                  docker compose up -d --build
#
# AKSES SERVICES:
# ===============
# ðŸŒ Aplikasi:      http://localhost:8080
# ðŸ“§ Mailpit:       http://localhost:8025
# ðŸ—„ï¸ phpMyAdmin:    http://localhost:8888
# ðŸ“Š Grafana:       http://localhost:3000  (admin/admin123secure)
# ðŸ“ˆ Prometheus:    http://localhost:9090
# ðŸ”´ Redis Insight: http://localhost:5540
#
# =============================================================================

networks:
  # Network internal untuk komunikasi antar services
  creativetrees-network:
    driver: bridge
    name: creativetrees-network

volumes:
  # Database persistence
  mysql-data:
    name: creativetrees-mysql-data

  # Redis persistence
  redis-data:
    name: creativetrees-redis-data

  # Laravel storage
  app-storage:
    name: creativetrees-app-storage

  # Monitoring data
  prometheus-data:
    name: creativetrees-prometheus-data
  grafana-data:
    name: creativetrees-grafana-data

  # Mailpit data
  mailpit-data:
    name: creativetrees-mailpit-data

services:
  # ===========================================================================
  # CORE APPLICATION SERVICES
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # PHP-FPM Application
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
      args:
        UID: ${DOCKER_UID:-1000}
        GID: ${DOCKER_GID:-1000}
    container_name: creativetrees-app
    restart: unless-stopped
    working_dir: /var/www/html
    env_file:
      - .env
    environment:
      CONTAINER_ROLE: app
      PHP_OPCACHE_ENABLE: 1
    volumes:
      - .:/var/www/html:cached
      - app-storage:/var/www/html/storage/app
    networks:
      - creativetrees-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || php -r 'exit(0);'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1024M
        reservations:
          cpus: "0.5"
          memory: 256M

  # ---------------------------------------------------------------------------
  # Nginx Web Server
  # ---------------------------------------------------------------------------
  web:
    image: nginx:1.27-alpine
    container_name: creativetrees-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-8080}:80"
    volumes:
      - .:/var/www/html:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - creativetrees-network
    depends_on:
      - app
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 256M

  # ---------------------------------------------------------------------------
  # Queue Worker
  # ---------------------------------------------------------------------------
  queue:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
      args:
        UID: ${DOCKER_UID:-1000}
        GID: ${DOCKER_GID:-1000}
    container_name: creativetrees-queue
    restart: unless-stopped
    env_file:
      - .env
    environment:
      CONTAINER_ROLE: queue
    command: php artisan queue:work --queue=emails,notifications,default --sleep=3 --tries=3 --timeout=90 --max-jobs=1000 --max-time=3600
    volumes:
      - .:/var/www/html:cached
      - app-storage:/var/www/html/storage/app
    networks:
      - creativetrees-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M

  # ---------------------------------------------------------------------------
  # Task Scheduler
  # ---------------------------------------------------------------------------
  scheduler:
    build:
      context: .
      dockerfile: docker/app/Dockerfile
      args:
        UID: ${DOCKER_UID:-1000}
        GID: ${DOCKER_GID:-1000}
    container_name: creativetrees-scheduler
    restart: unless-stopped
    env_file:
      - .env
    environment:
      CONTAINER_ROLE: scheduler
    command: php artisan schedule:work
    volumes:
      - .:/var/www/html:cached
      - app-storage:/var/www/html/storage/app
    networks:
      - creativetrees-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # ---------------------------------------------------------------------------
  # Node.js (Vite Dev Server)
  # ---------------------------------------------------------------------------
  node:
    image: node:20-alpine
    container_name: creativetrees-node
    restart: unless-stopped
    working_dir: /var/www/html
    user: node
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    volumes:
      - .:/var/www/html:cached
      - /var/www/html/node_modules
    ports:
      - "${VITE_PORT:-5173}:5173"
    networks:
      - creativetrees-network
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M

  # ===========================================================================
  # DATABASE SERVICES
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # MySQL 8.0
  # ---------------------------------------------------------------------------
  mysql:
    image: mysql:8.0
    container_name: creativetrees-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-db_creativetrees}
      MYSQL_USER: ${DB_USERNAME:-app}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      TZ: ${APP_TIMEZONE:-UTC}
    command:
      - --default-authentication-plugin=caching_sha2_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --innodb-buffer-pool-size=256M
      - --innodb-log-file-size=64M
      - --max-connections=200
      - --skip-name-resolve
      - --slow-query-log=1
      - --slow-query-log-file=/var/lib/mysql/slow.log
      - --long-query-time=2
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    networks:
      - creativetrees-network
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "127.0.0.1",
          "-u",
          "root",
          "-p${DB_ROOT_PASSWORD}",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1024M
        reservations:
          cpus: "0.5"
          memory: 512M

  # ---------------------------------------------------------------------------
  # Redis 7
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: creativetrees-redis
    restart: unless-stopped
    command:
      - redis-server
      - --requirepass
      - ${REDIS_PASSWORD:-creativetrees_redis_2026}
      - --maxmemory
      - 256mb
      - --maxmemory-policy
      - allkeys-lru
      - --appendonly
      - "yes"
      - --appendfsync
      - everysec
    volumes:
      - redis-data:/data
    networks:
      - creativetrees-network
    healthcheck:
      test:
        [
          "CMD",
          "redis-cli",
          "-a",
          "${REDIS_PASSWORD:-creativetrees_redis_2026}",
          "ping",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M

  # ===========================================================================
  # DATABASE MANAGEMENT TOOLS
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # phpMyAdmin
  # ---------------------------------------------------------------------------
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: creativetrees-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${DB_ROOT_PASSWORD}
      UPLOAD_LIMIT: 100M
      MEMORY_LIMIT: 256M
      MAX_EXECUTION_TIME: 300
    ports:
      - "${PMA_PORT:-8888}:80"
    networks:
      - creativetrees-network
    depends_on:
      mysql:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # ---------------------------------------------------------------------------
  # Redis Insight (Redis GUI)
  # ---------------------------------------------------------------------------
  redisinsight:
    image: redis/redisinsight:latest
    container_name: creativetrees-redisinsight
    restart: unless-stopped
    ports:
      - "${REDIS_INSIGHT_PORT:-5540}:5540"
    networks:
      - creativetrees-network
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # ===========================================================================
  # EMAIL TESTING
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # Mailpit (Email Catcher)
  # ---------------------------------------------------------------------------
  mailpit:
    image: axllent/mailpit:latest
    container_name: creativetrees-mailpit
    restart: unless-stopped
    environment:
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: /data/mailpit.db
      TZ: ${APP_TIMEZONE:-UTC}
    volumes:
      - mailpit-data:/data
    ports:
      - "${MAILPIT_HTTP_PORT:-8025}:8025"
      - "${MAILPIT_SMTP_PORT:-1025}:1025"
    networks:
      - creativetrees-network
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8025/livez"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M

  # ===========================================================================
  # MONITORING & OBSERVABILITY STACK
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # Prometheus (Metrics Collection)
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: creativetrees-prometheus
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"
    volumes:
      - ./docker/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/monitoring/prometheus.rules.yml:/etc/prometheus/prometheus.rules.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - creativetrees-network
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M

  # ---------------------------------------------------------------------------
  # Grafana (Visualization & Dashboards)
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: creativetrees-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin123secure}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: "http://localhost:${GRAFANA_PORT:-3000}"
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/monitoring/grafana/dashboards:/etc/grafana/dashboards:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    networks:
      - creativetrees-network
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M

  # ---------------------------------------------------------------------------
  # cAdvisor (Container Metrics)
  # ---------------------------------------------------------------------------
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: creativetrees-cadvisor
    restart: unless-stopped
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks:
      - creativetrees-network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # ---------------------------------------------------------------------------
  # Node Exporter (Host Metrics)
  # ---------------------------------------------------------------------------
  node-exporter:
    image: prom/node-exporter:latest
    container_name: creativetrees-node-exporter
    restart: unless-stopped
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.rootfs=/rootfs"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - creativetrees-network
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M

  # ---------------------------------------------------------------------------
  # Redis Exporter (Redis Metrics for Prometheus)
  # ---------------------------------------------------------------------------
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: creativetrees-redis-exporter
    restart: unless-stopped
    environment:
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-creativetrees_redis_2026}
    networks:
      - creativetrees-network
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 64M

  # ---------------------------------------------------------------------------
  # MySQL Exporter (MySQL Metrics for Prometheus)
  # ---------------------------------------------------------------------------
  mysql-exporter:
    image: prom/mysqld-exporter:latest
    container_name: creativetrees-mysql-exporter
    restart: unless-stopped
    environment:
      MYSQLD_EXPORTER_PASSWORD: ${DB_ROOT_PASSWORD}
    command:
      - "--mysqld.address=mysql:3306"
      - "--mysqld.username=root"
    networks:
      - creativetrees-network
    depends_on:
      mysql:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 64M

  # ---------------------------------------------------------------------------
  # Alertmanager (Alert Handling)
  # ---------------------------------------------------------------------------
  alertmanager:
    image: prom/alertmanager:latest
    container_name: creativetrees-alertmanager
    restart: unless-stopped
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
    volumes:
      - ./docker/monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    ports:
      - "${ALERTMANAGER_PORT:-9093}:9093"
    networks:
      - creativetrees-network
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M

# =============================================================================
# END OF DOCKER COMPOSE
# =============================================================================
#
# ðŸ“‹ QUICK COMMANDS:
# ------------------
# Start:          docker compose up -d
# Stop:           docker compose down
# Logs:           docker compose logs -f [service]
# Shell:          docker compose exec app bash
# Artisan:        docker compose exec app php artisan [cmd]
# Composer:       docker compose exec app composer [cmd]
# MySQL CLI:      docker compose exec mysql mysql -u root -p
# Redis CLI:      docker compose exec redis redis-cli -a $REDIS_PASSWORD
#
# ðŸ”§ MAINTENANCE:
# ---------------
# Rebuild:        docker compose up -d --build
# Update images:  docker compose pull && docker compose up -d
# Clean:          docker compose down -v --remove-orphans
# Stats:          docker stats
#
# ðŸ’¾ BACKUP:
# ----------
# MySQL:          docker compose exec mysql mysqldump -u root -p$DB_ROOT_PASSWORD $DB_DATABASE > backup.sql
# Redis:          docker compose exec redis redis-cli -a $REDIS_PASSWORD BGSAVE
#
# =============================================================================
